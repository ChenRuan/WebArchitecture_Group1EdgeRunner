<!DOCTYPE html>
<html>
<head>
    <title>伦敦Wards地图 - 谷歌地图版</title>
    <style>
        #map { height: 100%; }
        html, body { height: 100%; margin: 0; padding: 0; }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    var map;
    var heatmapData = [];

    function initMap() {
        console.log("Initializing map...");

        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 51.5074, lng: -0.1278 },
            zoom: 10
        });

        // 加载GeoJSON文件，并在加载完成后执行操作
        map.data.loadGeoJson('http://localhost:8000/workshopgroup/londonwards.geojson', null, function() {
            map.data.forEach(function(feature) {
                var wardName = feature.getProperty('NAME');
                var boroughName = feature.getProperty('BOROUGH');
                console.log("Fetching data for:", wardName, boroughName);
                fetchCrimeData(wardName, boroughName);
            });
        });

        map.data.addListener('click', function(event) {
            var feature = event.feature;
            var content = "Ward: " + feature.getProperty('NAME') +
                          "<br/>Borough: " + feature.getProperty('BOROUGH');
            var infowindow = new google.maps.InfoWindow({
                content: content,
                position: event.latLng
            });
            infowindow.open(map);
        });

        var heatmap = new google.maps.visualization.HeatmapLayer({
            data: heatmapData,
            map: map
        });

        console.log("Map initialized.");
    }

    function fetchCrimeData(wardName, boroughName) {
        var apiUrl = `http://casa0017.cetools.org:8848/crime-data?wardName=${wardName}&boroughName=${boroughName}`;
        console.log("API URL:", apiUrl);
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                console.log("API Response for", wardName, boroughName, ":", data);
                var crimeCount = data.TotalCases;
                heatmapData.push({location: new google.maps.LatLng(data.latitude, data.longitude), weight: crimeCount});
            })
            .catch(error => {
                console.error("Error fetching data for", wardName, boroughName, ":", error);
            });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxN3VbgUStEFo-wdH6uITsXN3Xuv5SkQ4&libraries=visualization&callback=initMap" async defer></script>
</body>
</html>


